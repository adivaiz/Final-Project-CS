{% load static %}
{% load i18n %}

{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" dir="rtl">
<head>
    <meta charset="UTF-8">
    {% if LANGUAGE_CODE == 'he' %}
    <title>{% trans "Interactive Map" %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- ספריות צד שלישי -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

    <!-- MapLibre CSS -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.css" rel="stylesheet" />

    <!-- CSS פרטי -->
    <link rel="stylesheet" href="{% static 'mapapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'mapapp/css/modal.css' %}">
    <link rel="icon" href="{% static 'mapapp/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
    {% else %}
    <title>{% trans "Interactive Map" %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- Third-party libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">

    <!-- MapLibre CSS -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'mapapp/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'mapapp/css/modal.css' %}">
    <link rel="icon" href="{% static 'mapapp/favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
    {% endif %}
</head>
<body>
    <!-- Navbar -->
    <nav>
        <!-- Mobile hamburger button (hidden on desktop) -->
        <button class="hamburger-menu" id="hamburger-toggle" aria-label="Toggle menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        
        <!-- Mobile country search (hidden on desktop) -->
        <div class="nav-search-mobile">
            <input type="text" id="countrySearchMobile" 
                   placeholder="{% if LANGUAGE_CODE == 'he' %}חפש מדינה...{% else %}Search Country...{% endif %}" 
                   aria-label="{% if LANGUAGE_CODE == 'he' %}חיפוש מדינה{% else %}Country Search{% endif %}">
            <div id="searchResultsMobile" class="search-results"></div>
        </div>
        
        <div class="nav-buttons" id="nav-menu">
            <!-- חיפוש מדינה (בצד ימין) - Desktop only -->
            <div class="simple-search desktop-only">
                <input type="text" id="countrySearch" 
                       placeholder="{% if LANGUAGE_CODE == 'he' %}חפש מדינה...{% else %}Search Country...{% endif %}" 
                       aria-label="{% if LANGUAGE_CODE == 'he' %}חיפוש מדינה{% else %}Country Search{% endif %}">
                <div id="searchResults" class="search-results"></div>
                <!-- כפתור חיפוש חיילים -->
                <button id="soldier-search-toggle" class="nav-button" 
                        title="{% if LANGUAGE_CODE == 'he' %}חיפוש חיילים{% else %}Search Soldiers{% endif %}">
                    <i class="fas fa-user-alt"></i>
                    <span class="nav-text">
                        {% if LANGUAGE_CODE == 'he' %}
                            חיפוש חיילים
                        {% else %}
                            Search Soldiers
                        {% endif %}
                    </span>
                </button>
                <!-- כפתור לוח נתונים -->
                <a href="{% url 'dashboard' %}" class="nav-button">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">
                        {% if LANGUAGE_CODE == 'he' %}
                            לוח נתונים
                        {% else %}
                            Dashboard
                        {% endif %}
                    </span>
                </a>
            </div>
            
            <!-- Mobile menu items -->
            <div class="mobile-menu-items">
                <!-- כפתור חיפוש חיילים -->
                <button id="soldier-search-toggle-mobile" class="nav-button mobile-item" 
                        title="{% if LANGUAGE_CODE == 'he' %}חיפוש חיילים{% else %}Search Soldiers{% endif %}">
                    <i class="fas fa-user-alt"></i>
                    <span class="nav-text">
                        {% if LANGUAGE_CODE == 'he' %}
                            חיפוש חיילים
                        {% else %}
                            Search Soldiers
                        {% endif %}
                    </span>
                </button>
                
                <!-- כפתור לוח נתונים -->
                <a href="{% url 'dashboard' %}" class="nav-button mobile-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-text">
                        {% if LANGUAGE_CODE == 'he' %}
                            לוח נתונים
                        {% else %}
                            Dashboard
                        {% endif %}
                    </span>
                </a>
                
                <!-- כפתור Dark Mode -->
                <button id="dark-mode-toggle-mobile" class="nav-button mobile-item" title="Dark Mode">
                    <i class="fas fa-moon"></i>
                    <span class="nav-text">

                        {% if LANGUAGE_CODE == 'he' %}
                            מצב לילה
                        {% else %}
                            Dark Mode
                        {% endif %}
                    </span>
                </button>
            </div>
        </div>
        
        <!-- Always visible buttons (timeline and language) - outside hamburger -->
        <div class="nav-always-visible">
            <!-- כפתור ציר זמן -->
            <button id="timeline-toggle" class="nav-button compact" data-action="timeline">
                <i class="fas fa-clock"></i>
                <span class="nav-text">
                    {% if LANGUAGE_CODE == 'he' %}
                        ציר זמן
                    {% else %}
                        Timeline
                    {% endif %}
                </span>
            </button>
            
            <!-- כפתור החלפת שפה -->
            <form method="POST" action="{% url 'set_language' %}" style="margin: 0;">
                {% csrf_token %}
                {% if LANGUAGE_CODE == 'he' %}
                    <input type="hidden" name="language" value="en">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="flag-button" title="Switch to English">
                        <img src="{% static 'mapapp/images/flag_us.png' %}" alt="English">
                    </button>
                {% else %}
                    <input type="hidden" name="language" value="he">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="flag-button" title="עבור לעברית">
                        <img src="{% static 'mapapp/images/flag_il.png' %}" alt="עברית">
                    </button>
                {% endif %}
            </form>
            
            <!-- כפתור חזרה -->
            <a href="{% url 'home' %}" class="nav-button compact" id="back-button">
                <i class="fas fa-arrow-right"></i>
                <span class="nav-text">
                    {% if LANGUAGE_CODE == 'he' %}
                        חזרה
                    {% else %}
                        Back
                    {% endif %}
                </span>
            </a>
        </div>
    </nav>

    <!-- מסך טעינה -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <svg width="60" height="60" viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="30" cy="30" r="28" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                    <path d="M30 8L35 18L45 15L40 25L50 30L40 35L45 45L35 42L30 52L25 42L15 45L20 35L10 30L20 25L15 15L25 18L30 8Z" 
                          fill="rgba(255,255,255,0.8)" stroke="rgba(255,255,255,0.9)" stroke-width="1"/>
                </svg>
            </div>
            <h1 class="loading-title">
                {% if LANGUAGE_CODE == 'he' %}
                    טוען מפה אינטראקטיבית
                {% else %}
                    Loading Interactive Map
                {% endif %}
            </h1>
            <div class="loading-subtitle">
                {% if LANGUAGE_CODE == 'he' %}
                    מוזיאון הלוחם היהודי במלחמת העולם השנייה
                {% else %}
                    Jewish World War II Fighter Museum
                {% endif %}
            </div>
            <div class="loading-progress">
                <div id="progressBar" class="progress-bar"></div>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            <div id="loadingText" class="loading-text">
                {% if LANGUAGE_CODE == 'he' %}
                    טוען את המפה...
                {% else %}
                    Loading map...
                {% endif %}
            </div>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- Timeline Fixed Container בצד שמאל (מוסתר כברירת מחדל) -->
    <div id="timeline-fixed-container" style="display: none;">
        <button id="timeline-close-btn" 
                title="{% if LANGUAGE_CODE == 'he' %}סגור ציר זמן{% else %}Close Timeline{% endif %}">×</button>
        <div id="timeline-container">
            <div class="timeline-header"></div>
            <div id="timeline-events" class="timeline-events"></div>
        </div>
    </div>

    <div class="main-container">
        <header class="map-header">
            <div class="logo-container">
                <a href="{% url 'home' %}">
                    <img src="{% static 'mapapp/images/logo.svg' %}" alt="לוגו המוזיאון">
                </a>
                <span class="logo-text">
                    {% if LANGUAGE_CODE == 'he' %}
                        מוזיאון הלוחם היהודי
                    {% else %}
                        Jewish Fighter Museum
                    {% endif %}
                </span>
            </div>
            <div class="nav-buttons">
                <form method="POST" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="website">
                    <button type="submit">אתר ראשי</button>
                </form>
                <form method="POST" action="/i18n/setlang/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="language" value="he">
                    <button type="submit">עברית</button>
                </form>
                <form method="POST" action="/i18n/setlang/" style="display: inline;">
                    {% csrf_token %}
                    <input type="hidden" name="language" value="en">
                    <button type="submit">English</button>
                </form>
            </div>
        </header>
        <div id="map">
            <!-- אין כאן חיפוש, החיפוש נמצא בתוך הnavbar -->
        </div>
    </div>

    <!-- מודאל משודרג -->
    <div id="eventModal" class="modal">
        <div id="eventContent" class="content">
        <!-- כפתור סגירה -->
        <div class="modal-controls">
            <button id="eventClose" class="eventClose" onclick="closeModal()">
                <span class="closeText">סגור</span>
                <span class="closeX">×</span>
            </button>
            </div>

            <div class="modal-layout-grid">
                <!-- Rifht Column -->
                <div class="soldiers-section">
                    <h3 id="soldiersTitle">
                        {% if LANGUAGE_CODE == 'he' %}
                            לוחמים ממדינה זו:
                        {% else %}
                            Fighters from this country:
                        {% endif %}
                    </h3>
                    <div class="soldiers-search-container">
                        <input type="text" id="soldiersSearch" class="soldiers-search" 
                               placeholder="{% if LANGUAGE_CODE == 'he' %}חפש לוחמים...{% else %}Search fighters...{% endif %}" 
                               aria-label="{% if LANGUAGE_CODE == 'he' %}חפש לוחמים{% else %}Search fighters{% endif %}">
                        <button id="clearSearch" class="clear-search" 
                                aria-label="{% if LANGUAGE_CODE == 'he' %}נקה חיפוש{% else %}Clear search{% endif %}">×</button>
                        <button id="advancedFilterButton" class="advanced-filter-button" 
                                title="{% if LANGUAGE_CODE == 'he' %}סינון מתקדם{% else %}Advanced Filter{% endif %}">
                            <i class="filter-icon">⚙️</i>
                        </button>
                    </div>
                    
                    <div id="advancedFilters" class="advanced-filters">
                        <form id="filterForm" class="filter-form">
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="genderFilter">
                                        {% if LANGUAGE_CODE == 'he' %}מגדר:{% else %}Gender:{% endif %}
                                    </label>
                                    <select id="genderFilter">
                                        <option value="">{% if LANGUAGE_CODE == 'he' %}הכל{% else %}All{% endif %}</option>
                                        <option value="זכר">{% if LANGUAGE_CODE == 'he' %}זכר{% else %}Male{% endif %}</option>
                                        <option value="נקבה">{% if LANGUAGE_CODE == 'he' %}נקבה{% else %}Female{% endif %}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="yearFromFilter">
                                        {% if LANGUAGE_CODE == 'he' %}משנת לידה:{% else %}From birth year:{% endif %}
                                    </label>
                                    <input type="number" id="yearFromFilter" min="1900" max="1945" 
                                           placeholder="{% if LANGUAGE_CODE == 'he' %}מ...{% else %}From...{% endif %}">
                                </div>
                                
                                <div class="filter-group">
                                    <label for="yearToFilter">
                                        {% if LANGUAGE_CODE == 'he' %}עד שנת לידה:{% else %}To birth year:{% endif %}
                                    </label>
                                    <input type="number" id="yearToFilter" min="1900" max="1945" 
                                           placeholder="{% if LANGUAGE_CODE == 'he' %}עד...{% else %}To...{% endif %}">
                                </div>
                            </div>
                            
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="sortByFilter">
                                        {% if LANGUAGE_CODE == 'he' %}מיון לפי:{% else %}Sort by:{% endif %}
                                    </label>
                                    <select id="sortByFilter">
                                        <option value="name">{% if LANGUAGE_CODE == 'he' %}שם{% else %}Name{% endif %}</option>
                                        <option value="birth_date">{% if LANGUAGE_CODE == 'he' %}תאריך לידה{% else %}Birth Date{% endif %}</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-buttons">
                                <button type="button" id="applyFilters" class="apply-filters-btn">
                                    {% if LANGUAGE_CODE == 'he' %}החל סינון{% else %}Apply Filter{% endif %}
                                </button>
                                <button type="button" id="resetFilters" class="reset-filters-btn">
                                    {% if LANGUAGE_CODE == 'he' %}איפוס{% else %}Reset{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="soldiersContainer" class="soldiers-list scrollable"></div>
                </div>

                <!-- Middle Column -->
                <div class="passport">
                    <caption class="event-caption">
                        <div class="caption-wrapper">
                            <span id="eventTitle" class="uppercase">שם האירוע</span>
                            <div id="insetMapPlaceholder" class="map-placeholder">
                                <img id="countryFlag" src="" alt="דגל המדינה">
                            </div>
                        </div>
                    </caption>
                    
                    <!-- Event Cards Container -->
                    <div id="eventsContainer" class="events-cards-container">
                        <!-- Events will be dynamically added here as cards -->
                    </div>

                    <!-- Event Details Section -->
                    <div id="eventDetails" class="event-details">
                        <div class="event-description">
                            {% if LANGUAGE_CODE == 'he' %}
                            <h3>תיאור האירוע</h3>
                            {% else %}
                            <h3>Event Description</h3>
                            {% endif %}
                            <div id="eventSummary" class="scrollable">
                                <!-- Event description will be added here -->
                                <div class="event-info">
                                    <div class="info-row">
                                        <strong>תאריך התחלה:</strong>
                                        <span id="startDate">25/08/1941</span>
                                    </div>
                                    <div class="info-row">
                                        <strong>תאריך סיום:</strong>
                                        <span id="endDate">30/08/1941</span>
                                    </div>
                                    <div class="info-row">
                                        <strong>מיקום:</strong>
                                        <span id="location">איראן</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- מודאל לפרטי לוחם -->
    <div id="soldierModal" class="modal">
        <div id="soldierContent" class="content">
            <!-- כפתור סגירה -->
            <div class="modal-controls">
                <button id="soldierClose" class="eventClose" onclick="closeSoldierModal()">
                    <span class="closeText">{% if LANGUAGE_CODE == 'he' %}סגור{% else %}Close{% endif %}</span>
                    <span class="closeX">×</span>
                </button>
            </div>

            <div class="soldier-layout-grid">
                <!-- Soldier Profile - Full Width -->
                <div class="soldier-profile-full">
                    <div class="soldier-header">
                        <div class="soldier-avatar">
                            <img id="soldierImage" src="" alt="תמונת הלוחם">
                        </div>
                        <div class="soldier-title">
                            <h2 id="soldierName" class="uppercase"></h2>
                            <div id="soldierBadge" class="badge"></div>
                        </div>
                    </div>

                    <div class="soldier-details scrollable">
                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}פרטים אישיים{% else %}Personal Details{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}תאריך לידה:{% else %}Birth Date:{% endif %}</strong>
                                    <span id="soldierBirthDate"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}עיר לידה:{% else %}Birth City:{% endif %}</strong>
                                    <span id="soldierBirthCity"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}מדינת לידה:{% else %}Birth Country:{% endif %}</strong>
                                    <span id="soldierBirthCountry"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}שם האב:{% else %}Father's Name:{% endif %}</strong>
                                    <span id="soldierFatherName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}שם האם:{% else %}Mother's Name:{% endif %}</strong>
                                    <span id="soldierMotherName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}שם משפחה קודם:{% else %}Previous Last Name:{% endif %}</strong>
                                    <span id="soldierPreviousLastName"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}כינוי:{% else %}Nickname:{% endif %}</strong>
                                    <span id="soldierNickname"></span>
                                </div>
                            </div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}שירות צבאי{% else %}Military Service{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}צבא:{% else %}Army:{% endif %}</strong>
                                    <span id="soldierArmy"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}תפקיד:{% else %}Role:{% endif %}</strong>
                                    <span id="soldierRole"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}דרגה:{% else %}Rank:{% endif %}</strong>
                                    <span id="soldierRank"></span>
                                </div>
                            </div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}השתתפות במלחמה{% else %}War Participation{% endif %}</h3>
                            <div id="soldierParticipation" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}עיטורים{% else %}Decorations{% endif %}</h3>
                            <div id="soldierDecorations" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}ביוגרפיה{% else %}Biography{% endif %}</h3>
                            <div id="soldierBiography" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}תיאור הלחימה{% else %}Fighting Description{% endif %}</h3>
                            <div id="soldierFightingDesc" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}תיאור הגטו{% else %}Ghetto Description{% endif %}</h3>
                            <div id="soldierGettoDesc" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}פציעות{% else %}Wounds{% endif %}</h3>
                            <div id="soldierWounds" class="text-block"></div>
                        </div>

                        <div class="details-section">
                            <h3>{% if LANGUAGE_CODE == 'he' %}מידע על פטירה{% else %}Death Information{% endif %}</h3>
                            <div class="details-grid">
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}תאריך פטירה:{% else %}Death Date:{% endif %}</strong>
                                    <span id="soldierDeathDate"></span>
                                </div>
                                <div class="info-row">
                                    <strong>{% if LANGUAGE_CODE == 'he' %}מקום פטירה:{% else %}Place of Death:{% endif %}</strong>
                                    <span id="soldierDeathPlace"></span>
                                </div>
                            </div>
                            <div id="soldierDeathDetails" class="text-block"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- מודל חיפוש חיילים -->
    <div id="soldierSearchModal" class="modal">
        <div class="modal-content soldier-search-modal">
            <div class="modal-header">
                <h2>{% if LANGUAGE_CODE == 'he' %}חיפוש חיילים{% else %}Search Soldiers{% endif %}</h2>
                <button class="close-button" onclick="closeSoldierSearchModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="search-input-container">
                    <input type="text" id="soldierSearchInput" 
                           placeholder="{% if LANGUAGE_CODE == 'he' %}הקלד שם חייל...{% else %}Type soldier name...{% endif %}" 
                           autofocus>
                    <i class="fas fa-search search-icon"></i>
                </div>
                <div id="soldierSearchResults" class="soldier-search-results"></div>
            </div>
        </div>
    </div>

    <!-- MapLibre JS -->
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.3.1/dist/maplibre-gl.min.js"></script>

    <!-- הגדרת מפתחות API בצורה בטוחה -->
    <script>
        // Global configuration for production
        window.WW2_CONFIG = {
            MAPTILER_API_KEY: '{{ MAPTILER_API_KEY|default:"" }}',
            GEMINI_API_KEY: '{{ GEMINI_API_KEY|default:"" }}',
            DEBUG: {% if DEBUG %}true{% else %}false{% endif %},
            APP_NAME: 'WW2 Map',
            VERSION: '1.0.0',
            SUPPORTED_LANGUAGES: ['he', 'en']
        };
    </script>
    
    <!-- Modal Manager -->
    <script type="module" src="{% static 'mapapp/js/modalManager.js' %}"></script>
    
    <!-- קובץ JS ראשי -->
    <script type="module" src="{% static 'mapapp/js/index.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Hamburger menu functionality
            const hamburgerToggle = document.getElementById('hamburger-toggle');
            const navMenu = document.getElementById('nav-menu');
            
            if (hamburgerToggle && navMenu) {
                hamburgerToggle.addEventListener('click', function() {
                    hamburgerToggle.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });
                
                // Close menu when clicking on nav items (only items inside the hamburger menu)
                const navButtons = navMenu.querySelectorAll('.nav-button, .flag-button');
                navButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        hamburgerToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    });
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!hamburgerToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        hamburgerToggle.classList.remove('active');
                        navMenu.classList.remove('active');
                    }
                });
            }
            
            // Timeline functionality
            const openBtn = document.getElementById('timeline-open-btn');
            const closeBtn = document.getElementById('timeline-close-btn');
            const timelineToggle = document.getElementById('timeline-toggle');
            const timelineFixed = document.getElementById('timeline-fixed-container');
            const navbar = document.querySelector('nav');
            
            // פתיחה/סגירה עם הכפתור בnavbar
            if (timelineToggle && timelineFixed && navbar) {
                timelineToggle.addEventListener('click', function() {
                    if (timelineFixed.style.display === 'none' || timelineFixed.style.display === '') {
                        timelineFixed.style.display = 'flex';
                        timelineToggle.classList.add('active');
                        navbar.classList.add('timeline-open');
                        if (openBtn) openBtn.style.display = 'none';
                    } else {
                        timelineFixed.style.display = 'none';
                        timelineToggle.classList.remove('active');
                        navbar.classList.remove('timeline-open');
                        if (openBtn) openBtn.style.display = 'block';
                    }
                });
            }
            
            // פתיחה עם הכפתור הצף (אם קיים)
            if (openBtn && timelineFixed && navbar) {
                openBtn.addEventListener('click', function() {
                    timelineFixed.style.display = 'flex';
                    openBtn.style.display = 'none';
                    navbar.classList.add('timeline-open');
                    if (timelineToggle) timelineToggle.classList.add('active');
                });
            }
            
            // סגירה עם כפתור X
            if (closeBtn && timelineFixed && navbar) {
                closeBtn.addEventListener('click', function() {
                    timelineFixed.style.display = 'none';
                    navbar.classList.remove('timeline-open');
                    if (openBtn) openBtn.style.display = 'block';
                    if (timelineToggle) timelineToggle.classList.remove('active');
                });
            }
            
            // Mobile search functionality
            const countrySearchMobile = document.getElementById('countrySearchMobile');
            const searchResultsMobile = document.getElementById('searchResultsMobile');
            
            if (countrySearchMobile && searchResultsMobile) {
                // Mobile search functions
                function performMobileSearch() {
                    const searchTerm = countrySearchMobile.value.toLowerCase();
                    if (searchTerm.length < 1) {
                        searchResultsMobile.style.display = 'none';
                        return;
                    }
                    
                    // Get current language from document
                    const currentLang = document.documentElement.lang || 'he';
                    
                    let results = [];
                    if (currentLang === 'he') {
                        // Search in Hebrew names - return Hebrew names
                        results = Object.keys(window.countries || {}).filter(country => 
                            country.toLowerCase().includes(searchTerm)
                        );
                    } else {
                        // Search in English names - return English names
                        results = Object.keys(window.countries || {})
                            .filter(country => (window.countries[country] || '').toLowerCase().includes(searchTerm))
                            .map(country => window.countries[country]); // Return English names
                    }
                    
                    displayMobileResults(results);
                }
                
                function displayMobileResults(results) {
                    searchResultsMobile.innerHTML = '';
                    
                    if (results.length === 0) {
                        searchResultsMobile.style.display = 'none';
                        return;
                    }
                    
                    // Get current language from document
                    const currentLang = document.documentElement.lang || 'he';
                    
                    results.forEach(countryName => {
                        const div = document.createElement('div');
                        // The countryName is already in the correct language from performMobileSearch
                        div.textContent = countryName;
                        div.addEventListener('click', () => {
                            selectMobileCountry(countryName);
                        });
                        searchResultsMobile.appendChild(div);
                    });
                    
                    searchResultsMobile.style.display = 'block';
                }
                
                function selectMobileCountry(countryName) {
                    // Get current language to determine how to process the country name
                    const currentLang = document.documentElement.lang || 'he';
                    
                    let hebrewName, englishName, countryCode;
                    
                    if (currentLang === 'he') {
                        // countryName is Hebrew, find the English equivalent
                        hebrewName = countryName;
                        englishName = window.countries[countryName];
                        countryCode = englishName;
                    } else {
                        // countryName is English, find the Hebrew equivalent
                        englishName = countryName;
                        hebrewName = Object.keys(window.countries).find(key => window.countries[key] === countryName) || countryName;
                        countryCode = englishName;
                    }
                    
                    if (window.openCountryModal) {
                        window.openCountryModal(countryCode, hebrewName);
                    }
                    searchResultsMobile.style.display = 'none';
                    countrySearchMobile.value = countryName;
                }
                
                // Mobile search event listeners
                countrySearchMobile.addEventListener('focus', () => {
                    if (countrySearchMobile.value.length > 0) {
                        performMobileSearch();
                    }
                });
                
                countrySearchMobile.addEventListener('input', performMobileSearch);
                
                countrySearchMobile.addEventListener('keydown', (e) => {
                    const resultItems = searchResultsMobile.querySelectorAll('div');
                    const currentActiveIndex = [...resultItems].findIndex(item => item.classList.contains('active'));
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            if (resultItems.length > 0) {
                                const nextIndex = currentActiveIndex >= 0 && currentActiveIndex < resultItems.length - 1 ? 
                                    currentActiveIndex + 1 : 0;
                                
                                resultItems.forEach(item => item.classList.remove('active'));
                                resultItems[nextIndex].classList.add('active');
                                resultItems[nextIndex].scrollIntoView({ block: 'nearest' });
                            }
                            break;
                            
                        case 'ArrowUp':
                            e.preventDefault();
                            if (resultItems.length > 0) {
                                const prevIndex = currentActiveIndex > 0 ? 
                                    currentActiveIndex - 1 : resultItems.length - 1;
                                
                                resultItems.forEach(item => item.classList.remove('active'));
                                resultItems[prevIndex].classList.add('active');
                                resultItems[prevIndex].scrollIntoView({ block: 'nearest' });
                            }
                            break;
                            
                        case 'Enter':
                            if (currentActiveIndex >= 0) {
                                e.preventDefault();
                                const countryName = resultItems[currentActiveIndex].textContent;
                                selectMobileCountry(countryName);
                            } else if (resultItems.length > 0) {
                                e.preventDefault();
                                const countryName = resultItems[0].textContent;
                                selectMobileCountry(countryName);
                            }
                            break;
                            
                        case 'Escape':
                            e.preventDefault();
                            searchResultsMobile.style.display = 'none';
                            break;
                    }
                });
                
                // Close mobile search results when clicking outside
                document.addEventListener('click', (e) => {
                    const mobileSearchContainer = document.querySelector('.nav-search-mobile');
                    if (mobileSearchContainer && !mobileSearchContainer.contains(e.target)) {
                        searchResultsMobile.style.display = 'none';
                    }
                });
            }
            
            // Close hamburger menu when mobile soldier search is clicked
            const soldierSearchToggleMobile = document.getElementById('soldier-search-toggle-mobile');
            if (soldierSearchToggleMobile) {
                soldierSearchToggleMobile.addEventListener('click', function() {
                    // Close hamburger menu
                    hamburgerToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            }
            
            // Mobile dark mode toggle functionality
            const darkModeToggleMobile = document.getElementById('dark-mode-toggle-mobile');
            if (darkModeToggleMobile) {
                darkModeToggleMobile.addEventListener('click', function() {
                    // Toggle dark mode
                    document.body.classList.toggle('dark-mode');
                    
                    // Save preference to localStorage
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('darkMode', isDarkMode);
                    
                    // Close hamburger menu
                    hamburgerToggle.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            }
        });
    </script>
    <script src="{% static 'mapapp/js/map.js' %}"></script>
</body>
</html>
